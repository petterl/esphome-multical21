# ESPHome configuration for Kamstrup Multical 21 Water Meter Reader
# ESP8266 Version (D1 Mini / NodeMCU / ESP-12)
#
# Hardware connections for ESP8266 (D1 Mini pin names):
#   CC1101 VCC  -> 3V3
#   CC1101 GND  -> GND
#   CC1101 CSN  -> GPIO 15 (D8)
#   CC1101 MOSI -> GPIO 13 (D7)
#   CC1101 MISO -> GPIO 12 (D6)
#   CC1101 SCK  -> GPIO 14 (D5)
#   CC1101 GDO0 -> GPIO 4  (D2)

substitutions:
  device_name: watermeter
  friendly_name: "Water Meter"
  # Get meter_id from the sticker on your meter (8 hex chars)
  meter_id: !secret multical21_meter_id
  # Get encryption key from your water provider (32 hex chars)
  meter_key: !secret multical21_meter_key

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: 600
    then:
      - logger.log:
          level: INFO
          tag: "boot"
          format: "\n\n\
            _______________________________________________________________\n\
            \n\
            \x20 __    __  __  __  __   ______  ____  ___    __    __     ___  __\n\
            \x20|  \\  /  ||  ||  ||  | |      ||    ||   \\  /  \\  |  |   |__ ||  |\n\
            \x20|   \\/   ||  ||  ||  |   ||   ||    ||    |/    \\ |  |      / |  |\n\
            \x20|        ||  ||  ||  |   ||   ||    ||    /  /\\  \\|  |     /  |__|\n\
            \x20|  |\\/|  ||  ||  ||  |   ||   ||    ||   |  /__\\  |  |    /   ____\n\
            \x20|  |  |  ||__||__||__|   ||   ||____||   | /    \\ |  |__ /__ |____|\n\
            \n\
            \x20              .---.                  _______\n\
            \x20             /     \\                |  .-.  |\n\
            \x20       ~~~~~~|     |~~~~~~          | |   | |\n\
            \x20      (   )  |  W  |  (   )         | | O |=+===\n\
            \x20       ~~~   | m3  |   ~~~          | |   | |   |\n\
            \x20             |_____|                |__|__|_|   |\n\
            \x20                                        \\   o  |\n\
            \x20      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~       \\ o   |\n\
            \x20      ============================--------'o---'\n\
            \n\
            \x20            << wM-Bus Mode C1 @ 868.95 MHz >>\n\
            \x20              Kamstrup Water Meter Reader\n\
            _______________________________________________________________\n\n"

esp8266:
  board: d1_mini  # Change to: nodemcuv2, esp12e, etc. for your board
  framework:
    version: recommended

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

captive_portal:

# Status LED (D1 Mini built-in LED on GPIO2)
status_led:
  pin:
    number: GPIO2
    inverted: true

# SPI bus for CC1101
spi:
  id: spi_bus
  clk_pin: GPIO14   # D5
  mosi_pin: GPIO13  # D7
  miso_pin: GPIO12  # D6

# External custom components
external_components:
  - source: github://petterl/esp32-multical21@master
    components: [multical21]

# Multical21 water meter sensor
multical21:
  id: water_meter
  spi_id: spi_bus
  cs_pin: GPIO15    # D8
  gdo0_pin: GPIO4   # D2
  meter_id: ${meter_id}
  key: ${meter_key}

sensor:
  # Water meter sensors
  - platform: multical21
    multical21_id: water_meter
    total_consumption:
      name: "Total Water Consumption"
    month_start_value:
      name: "Month Start Value"
    water_temperature:
      name: "Water Temperature"
    ambient_temperature:
      name: "Ambient Temperature"
    current_flow:
      name: "Current Water Flow"

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # Uptime sensor
  - platform: uptime
    name: "Uptime"

text_sensor:
  # Last update timestamp
  - platform: multical21
    multical21_id: water_meter
    last_update:
      name: "Last Update"

  # WiFi info
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

binary_sensor:
  # Connection status
  - platform: status
    name: "Status"

button:
  # Restart button
  - platform: restart
    name: "Restart"
