# ESPHome configuration for Kamstrup Multical 21 Water Meter Reader
# Standard ESP32 variant
#
# Hardware connections for Standard ESP32:
#   CC1101 VCC  -> 3V3
#   CC1101 GND  -> GND
#   CC1101 CSN  -> GPIO 4
#   CC1101 MOSI -> GPIO 23
#   CC1101 MISO -> GPIO 19
#   CC1101 SCK  -> GPIO 18
#   CC1101 GDO0 -> GPIO 32

substitutions:
  device_name: watermeter
  friendly_name: "Water Meter"
  # Meter ID (4 bytes, hex format without 0x prefix, e.g., "12345678")
  meter_id: "00000000"
  # AES-128 decryption key (32 hex characters, obtain from water provider)
  meter_key: "00000000000000000000000000000000"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    version: recommended

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

captive_portal:

# Status LED
status_led:
  pin: GPIO2

# SPI bus for CC1101
spi:
  clk_pin: GPIO18
  mosi_pin: GPIO23
  miso_pin: GPIO19

# External custom components
external_components:
  - source:
      type: local
      path: components

# Multical21 water meter sensor
multical21:
  id: water_meter
  cs_pin: GPIO4
  gdo0_pin: GPIO32
  meter_id: ${meter_id}
  key: ${meter_key}

sensor:
  # Water meter sensors
  - platform: multical21
    multical21_id: water_meter
    total_consumption:
      name: "Total Water Consumption"
      icon: "mdi:water"
    month_start_value:
      name: "Month Start Value"
      icon: "mdi:calendar-month"
    water_temperature:
      name: "Water Temperature"
      icon: "mdi:thermometer-water"
    ambient_temperature:
      name: "Ambient Temperature"
      icon: "mdi:thermometer"
    current_flow:
      name: "Current Water Flow"
      icon: "mdi:water-pump"

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # Uptime sensor
  - platform: uptime
    name: "Uptime"

text_sensor:
  # Last update timestamp
  - platform: multical21
    multical21_id: water_meter
    last_update:
      name: "Last Update"
      icon: "mdi:clock-outline"

  # WiFi info
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

binary_sensor:
  # Connection status
  - platform: status
    name: "Status"

button:
  # Restart button
  - platform: restart
    name: "Restart"
