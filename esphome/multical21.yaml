# ESPHome configuration for Kamstrup Multical 21 Water Meter Reader
# Uses CC1101 radio module to receive wM-Bus Mode C1 transmissions
#
# Hardware connections for ESP32-C3 Super Mini:
#   CC1101 VCC  -> 3V3
#   CC1101 GND  -> GND
#   CC1101 CSN  -> GPIO 7
#   CC1101 MOSI -> GPIO 6
#   CC1101 MISO -> GPIO 5
#   CC1101 SCK  -> GPIO 4
#   CC1101 GDO0 -> GPIO 10

substitutions:
  device_name: watermeter
  friendly_name: "Water Meter"
  # Get meter_id from the sticker on your meter (8 hex chars)
  meter_id: !secret multical21_meter_id
  # Get encryption key from your water provider (32 hex chars)
  meter_key: !secret multical21_meter_key

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-c3-devkitm-1
  variant: esp32c3
  framework:
    type: esp-idf
    version: recommended

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

captive_portal:

# Status LED
status_led:
  pin:
    number: GPIO8
    inverted: true

# SPI bus for CC1101
spi:
  clk_pin: GPIO4
  mosi_pin: GPIO6
  miso_pin: GPIO5

# External custom components
external_components:
  - source: github://petterl/esp32-multical21@master
    components: [multical21]

# Multical21 water meter sensor
multical21:
  id: water_meter
  cs_pin: GPIO7
  gdo0_pin: GPIO10
  meter_id: ${meter_id}
  key: ${meter_key}

sensor:
  # Total water consumption
  - platform: multical21
    multical21_id: water_meter
    total_consumption:
      name: "Total Water Consumption"
      icon: "mdi:water"
    month_start_value:
      name: "Month Start Value"
      icon: "mdi:calendar-month"
    water_temperature:
      name: "Water Temperature"
      icon: "mdi:thermometer-water"
    ambient_temperature:
      name: "Ambient Temperature"
      icon: "mdi:thermometer"

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # Uptime sensor
  - platform: uptime
    name: "Uptime"

text_sensor:
  # Last update timestamp
  - platform: multical21
    multical21_id: water_meter
    last_update:
      name: "Last Update"
      icon: "mdi:clock-outline"

  # WiFi info
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"

binary_sensor:
  # Connection status
  - platform: status
    name: "Status"

button:
  # Restart button
  - platform: restart
    name: "Restart"
